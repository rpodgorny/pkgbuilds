# Maintainer: Radek Podgorny <radek@podgorny.cz>
pkgname=atx-nsupdate
pkgver=1.5
pkgrel=1
pkgdesc="Asterix DNS updater"
arch=('any')
#url="https://github.com/ilanschnell/bitarray"
#license=('PSF')
depends=('python2' 'atx-pylib')
makedepends=('mercurial')
#options=(!emptydirs)
#source=(http://pypi.python.org/packages/source/b/bitarray/bitarray-${pkgver}.tar.gz)
#md5sums=('a1e80e63aec650721826d385b017201b')

#package() {
#  cd "$srcdir"/bitarray-$pkgver
#  python2 setup.py install --root="$pkgdir"/ --optimize=1
#}

# i had to rename this from single underscope to prevent makepkg from detecting this is a hg repo
__hgroot=http://hg.podgorny.cz/
__hgrepo=dnsutils

build() {
	cd "$srcdir"
	msg "Connecting to Mercurial server...."

	if [[ -d "$__hgrepo" ]]; then
		cd "$__hgrepo"
		hg pull
		msg "The local files are updated."
	else
		hg clone "$__hgroot" "$__hgrepo"
	fi
	hg up -r v$pkgver
	#hg up

	msg "Mercurial checkout done or server timeout"
	msg "Starting build..."

	rm -rf "$srcdir/$__hgrepo-build"
	cp -r "$srcdir/$__hgrepo" "$srcdir/$__hgrepo-build"
	cd "$srcdir/$__hgrepo-build"
}

package() {
	cd "$srcdir/$__hgrepo-build"
	#make DESTDIR="$pkgdir/" install

	install -d $pkgdir/usr/lib/systemd/system
	install nsupdate.service $pkgdir/usr/lib/systemd/system/

	install -d $pkgdir/etc
	install nsupdate.ini $pkgdir/etc/nsupdate.conf

	install -d $pkgdir/usr/bin
	install nsupdate.py $pkgdir/usr/bin/nsupdate
	install server.py $pkgdir/usr/bin/nsupdate-server
	install nsupdate-zone.py $pkgdir/usr/bin/
}
